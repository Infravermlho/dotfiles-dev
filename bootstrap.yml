#TODO: Keyring
#TODO: Conform for yml files

- name: Bootstrap development environment
  hosts: localhost
  vars_prompt:
    - name: sudo_password
      prompt: Insert sudo password
  vars:
    ansible_become_password: "{{ sudo_password }}"

  tasks:
  - name: Update with pacman -Syu
    become: yes
    community.general.pacman:
      update_cache: true
      upgrade: true

  - name: Install packages with pacman
    become: yes
    community.general.pacman:
      name:
        - git
        - tmux
        - neovim
        - fish
        - base-devel
        - stow
        - python-pexpect
        - openssh
      state: present

  - name: change user shell to FISH 
    become: yes
    user:
      name: "{{ ansible_user_id }}"
      shell: /usr/bin/fish

  - name: Run stow
    shell: "stow . --target {{ ansible_env.HOME }} --verbose=2"
    register: result
    changed_when: 'result.stderr is search("LINK: ")'

  # Installing yay
  - name: Git clone yay repository
    ansible.builtin.git:
      repo: 'https://aur.archlinux.org/yay.git'
      dest: /tmp/yay

  - name: Install package yay
    expect:
      command: "makepkg -si --noconfirm"
      chdir: /tmp/yay
      responses:
          (?i)password: "{{ sudo_password }}"
    changed_when: False

